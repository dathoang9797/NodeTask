(()=>{"use strict";var e={201:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.ErrorController=void 0;const a=t(629),o=t(894),{errorSomeThingWrong:s,errorDuplicate:n,errorCastMongoose:i,errorValidation:d,errorInvalidToken:l,errorTokenExpired:u}=o.MessageLog;r.ErrorController=(e,r,t,o)=>{e.status=e.status||"error",e.statusCode=e.statusCode||500;{let r={...e};return"CastError"===e.name&&(r=(e=>{const r=i(e);return new a.AppErrorHandling(r,400)})(r)),11e3===r.code&&(r=(e=>{const r=e.errmsg.match(/(["'])(?:(?=(\\?))\2.)*?\1/),t=n(r);return new a.AppErrorHandling(t,400)})(r)),"ValidationError"===r.name&&(r=(e=>{const r=Object.values(e.errors).map((e=>e.message)),t=d(r);return new a.AppErrorHandling(t,400)})(r)),"JsonWebTokenError"===r.name&&(r=new a.AppErrorHandling(l,401)),"TokenExpiredError"===r.name&&(r=new a.AppErrorHandling(u,401)),((e,r)=>{e.isOperational?r.status(e.statusCode).json({status:e.status,message:e.message}):(console.error("ERROR ðŸŽ†",e),r.status(500).json({status:"error",message:s}))})(r,t)}}},461:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.getTaskById=r.getTask=r.createTask=void 0;const a=t(614),o=t(894);r.createTask=(0,o.catchError)((async(e,r,t)=>{const s=e.user,n=new a.TaskModel({...e.body,owner:s._id});if(!n){const{errorCreateTask:e}=o.MessageLog;return t(new o.AppErrorHandling(e,400))}await n.save(),r.status(201).send(n)})),r.getTask=(0,o.catchError)((async(e,r,t)=>{const a=e.user,s={},n={};if(e.query.completed&&(s.completed="true"===e.query.completed),e.query.sortBy){const r=e.query.sortBy.split(":");n[r[0]]="desc"===r[1]?-1:1}if(!await a.populate({path:"tasks",match:s,options:{limit:parseInt(e.query.limit),skip:parseInt(e.query.skip),sort:n}})){const{errorFetchTasks:e}=o.MessageLog;return t(new o.AppErrorHandling(e,400))}r.send(e.user.tasks)})),r.getTaskById=(0,o.catchError)((async(e,r,t)=>{const s=await a.TaskModel.findOne({_id:e.params.id,owner:e.user._id});if(!s){const{errorFetchTasks:e}=o.MessageLog;return t(new o.AppErrorHandling(e,400))}r.send(s)}))},806:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.getAvatarUser=r.deleteAvatarUser=r.uploadAvatarUser=r.deleteUser=r.getUserMe=r.getUserById=r.getUser=r.userLogoutAll=r.userLogout=r.userLogin=r.createUser=void 0;const o=a(t(441)),s=t(894),n=t(791),i=t(95),{errorCreateUser:d}=s.MessageLog;r.createUser=(0,s.catchError)((async(e,r,t)=>{const a=new n.UserModel(e.body);if(!a)return t(new s.AppErrorHandling(d,500));await a.save(),(0,i.sendWelcomeEmail)(a.email,a.name);const o=await a.generateAuthToken();r.status(201).send({user:a,token:o})})),r.userLogin=(0,s.catchError)((async(e,r,t)=>{const a=await n.UserModel.findByCredentials(e.body.email,e.body.password);if(!a)return t(new s.AppErrorHandling(d,400));const o=await a.generateAuthToken();r.send({user:a,token:o})})),r.userLogout=(0,s.catchError)((async(e,r,t)=>{e.user.tokens=e.user.tokens.filter((r=>r.token!==e.token));if(!(await e.user.save()).isNew)return t(new s.AppErrorHandling(d,500));r.send()})),r.userLogoutAll=(0,s.catchError)((async(e,r,t)=>{e.user.tokens=[];if(!(await e.user.save()).isNew)return t(new s.AppErrorHandling(d,500));r.send()})),r.getUser=(0,s.catchError)((async(e,r,t)=>{if(e.user)return t(new s.AppErrorHandling(d,500));r.send(e.user)})),r.getUserById=(0,s.catchError)((async(e,r,t)=>{const a=await n.UserModel.findById(e.params.id);if(!a)return t(new s.AppErrorHandling(d,404));r.send(a)})),r.getUserMe=(0,s.catchError)((async(e,r,t)=>{const a=e.user,o=Object.keys(e.body),n=["name","email","password","age"];if(!o.every((e=>n.includes(e))))return t(new s.AppErrorHandling("Invalid updates",400));o.forEach((r=>a[r]=e.body[r]));if(!(await a.save()).isNew)return t(new s.AppErrorHandling("Updates Err",400));r.send(e.user)})),r.deleteUser=(0,s.catchError)((async(e,r,t)=>{if(!(await e.user.remove()).$isDeleted)return t(new s.AppErrorHandling("Delete Err",500));r.send(e.user)})),r.uploadAvatarUser=(0,s.catchError)((async(e,r,t)=>{const a=e.user;a.avatar=await(0,o.default)(e.file.buffer).resize({width:250,height:250}).png().toBuffer();if(!(await a.save()).isNew)return t(new s.AppErrorHandling("Upload Avatar Err",400));r.send()})),r.deleteAvatarUser=(0,s.catchError)((async(e,r,t)=>{e.user.avatar=void 0;if(!(await e.user.save()).$isDeleted)return t(new s.AppErrorHandling("Delete Avatar",400));r.send()})),r.getAvatarUser=(0,s.catchError)((async(e,r,t)=>{const a=await n.UserModel.findById(e.params.id);if(!a||!a.avatar)throw new Error;r.set("Content-Type","image/jpg"),r.send(a.avatar),r.status(404).send()}))},150:function(e,r,t){var a=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t);var o=Object.getOwnPropertyDescriptor(r,t);o&&!("get"in o?!r.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,a,o)}:function(e,r,t,a){void 0===a&&(a=t),e[a]=r[t]}),o=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&a(r,e,t);return o(r,e),r};Object.defineProperty(r,"__esModule",{value:!0}),r.UserController=r.TaskController=r.ErrorController=void 0,r.ErrorController=s(t(201)),r.TaskController=s(t(461)),r.UserController=s(t(806))},95:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.sendWelcomeEmail=void 0;const o=a(t(139));o.default.setApiKey("somekey");r.sendWelcomeEmail=(e,r)=>{o.default.send({to:e,from:"taskManager@gmail.com",subject:"Welcome to task manager",text:`Welcome to task manager ${r}!`,html:"<div>Hi!</div>"})}},614:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.TaskModel=void 0;const a=t(185),o=new a.Schema({description:{type:String,required:!0},completed:{type:Boolean,default:!1},owner:{type:a.Schema.Types.ObjectId,required:!0,ref:"User"}},{timestamps:!0});r.TaskModel=(0,a.model)("Task",o)},791:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.UserModel=void 0;const o=t(185),s=a(t(344)),n=a(t(96)),i=t(614),d=a(t(564)),l=new o.Schema({name:{type:String,required:!0,trim:!0},email:{type:String,required:!0,trim:!0,lowercase:!0,validate(e){if(!d.default.isEmail(e))throw new Error("Email is invalid")}},password:{type:String,required:!0,minlength:7,trim:!0,validate(e){if(e.toLowerCase().includes("passwords"))throw new Error('Password cannot contain "password"')}},age:{type:Number,default:0,validate(e){if(e<0)throw new Error("Age must be a positive number")}},tokens:[{token:{type:String}}],avatar:{type:Buffer}},{timestamps:!0});l.virtual("tasks",{ref:"Task",localField:"_id",foreignField:"owner"}),l.methods.generateAuthToken=async function(){const e=this,r=s.default.sign({_id:e._id.toSring()},"thisismynewcourse",{expiresIn:"7 days"});return e.token=e.tokens.concat({token:r}),await e.save(),r},l.methods.convertJSON=async function(){const e=this.toObject();return delete e.password,delete e.tokens,delete e.avatar,e},l.statics.findByCredentials=async(e,t)=>{const a=await r.UserModel.findOne({email:e});if(!a)throw new Error("Unable to login");if(!await n.default.compare(t,a.password))throw new Error("Unable to login");return a},l.pre("save",(async function(e){const r=this;r.isModified("password")&&(r.password=await n.default.hash(r.password,8)),e()})),l.pre("remove",{document:!0,query:!1},(async function(e){await i.TaskModel.deleteMany({owner:this._id}),e()})),r.UserModel=(0,o.model)("User",l)},629:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.AppErrorHandling=void 0;class t extends Error{statusCode;status;isOperational;constructor(e,r){super(e),this.statusCode=r,this.status=`${r}`.startsWith("4")?"fail":"error",this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}}r.AppErrorHandling=t},125:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.catchError=void 0;r.catchError=e=>(r,t,a)=>{e(r,t,a).catch((e=>a(e)))}},425:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.upload=void 0;const o=a(t(738));r.upload=(0,o.default)({limits:{fileSize:1e6},fileFilter(e,r,t){if(r.originalname.match(/\.(doc|docx)$/))return t(new Error("Error in upload format"));t(void 0,!0)}})},109:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.MessageLog=void 0;r.MessageLog={errorSignUp:"Can't SignUp User",errorCreateUser:"Can't Create User",messageSubjectEmailResetPassword:"Your password reset token valid for 10 min",messageTokenSentToEmail:"Token sent to email!",errorFetchUsers:"Can't fetch data user or delete the previous. Please try again later!",errorDeleteUser:"Can't delete user. Please try again later!",errorUpdateProfile:"Can't update profile",errorUpdateUser:"Can't update user",errorCreateTask:"Can't Create Task",errorFetchTasks:"Can't fetch data Task or delete the previous. Please try again later!",errorDeleteTask:"Can't delete Task. Please try again later!",errorUpdateTask:"Can't update Task",errorSomeThingWrong:"Something went very wrong!",errorInvalidToken:"Invalid token. Please log in again!",errorTokenExpired:"Your token has expired! PLease login agian!",errorDuplicate:e=>`Duplicate field value: ${e}. The User has been signup. PLease try use another phone or email`,errorCastMongoose:e=>`Invalid ${e.path}: ${e.value}`,errorValidation:e=>`Invalid input data. ${e.join(". ")} `,messageForgotPassword:e=>`Forgot your password? Submit a PATCH request with your new password and passwordConfirm to: ${e}.\n If you didn't forget your password, please ignore this email!`}},894:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.upload=r.MessageLog=r.catchError=r.AppErrorHandling=void 0;const a=t(629);Object.defineProperty(r,"AppErrorHandling",{enumerable:!0,get:function(){return a.AppErrorHandling}});const o=t(125);Object.defineProperty(r,"catchError",{enumerable:!0,get:function(){return o.catchError}});const s=t(109);Object.defineProperty(r,"MessageLog",{enumerable:!0,get:function(){return s.MessageLog}});const n=t(425);Object.defineProperty(r,"upload",{enumerable:!0,get:function(){return n.upload}})},139:e=>{e.exports=require("@sendgrid/mail")},96:e=>{e.exports=require("bcrypt")},344:e=>{e.exports=require("jsonwebtoken")},185:e=>{e.exports=require("mongoose")},738:e=>{e.exports=require("multer")},441:e=>{e.exports=require("sharp")},564:e=>{e.exports=require("validator")}},r={};(function t(a){var o=r[a];if(void 0!==o)return o.exports;var s=r[a]={exports:{}};return e[a].call(s.exports,s,s.exports,t),s.exports})(150)})();
//# sourceMappingURL=index.js.map