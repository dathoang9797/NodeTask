(()=>{"use strict";var e={427:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const a=s(t(185));a.default.set("strictQuery",!1),a.default.connect("mongodb://localhost:27017/node-task").then((()=>{console.log("Connect to MongoDB")})).catch((e=>console.log(e)))},201:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.ErrorController=void 0;const s=t(629),a=t(894),{errorSomeThingWrong:o,errorDuplicate:n,errorCastMongoose:i,errorValidation:u,errorInvalidToken:d,errorTokenExpired:l}=a.MessageLog;r.ErrorController=(e,r,t,a)=>{e.status=e.status||"error",e.statusCode=e.statusCode||500;{let r={...e};return"CastError"===e.name&&(r=(e=>{const r=i(e);return new s.AppErrorHandling(r,400)})(r)),11e3===r.code&&(r=(e=>{const r=e.errmsg.match(/(["'])(?:(?=(\\?))\2.)*?\1/),t=n(r);return new s.AppErrorHandling(t,400)})(r)),"ValidationError"===r.name&&(r=(e=>{const r=Object.values(e.errors).map((e=>e.message)),t=u(r);return new s.AppErrorHandling(t,400)})(r)),"JsonWebTokenError"===r.name&&(r=new s.AppErrorHandling(d,401)),"TokenExpiredError"===r.name&&(r=new s.AppErrorHandling(l,401)),((e,r)=>{e.isOperational?r.status(e.statusCode).json({status:e.status,message:e.message}):(console.error("ERROR ðŸŽ†",e),r.status(500).json({status:"error",message:o}))})(r,t)}}},461:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.getTaskById=r.getTask=r.createTask=void 0;const s=t(614),a=t(894);r.createTask=(0,a.catchError)((async(e,r,t)=>{const o=e.user,n=new s.TaskModel({...e.body,owner:o._id});if(!n){const{errorCreateTask:e}=a.MessageLog;return t(new a.AppErrorHandling(e,400))}await n.save(),r.status(201).send(n)})),r.getTask=(0,a.catchError)((async(e,r,t)=>{const s=e.user,o={},n={};if(e.query.completed&&(o.completed="true"===e.query.completed),e.query.sortBy){const r=e.query.sortBy.split(":");n[r[0]]="desc"===r[1]?-1:1}if(!await s.populate({path:"tasks",match:o,options:{limit:parseInt(e.query.limit),skip:parseInt(e.query.skip),sort:n}})){const{errorFetchTasks:e}=a.MessageLog;return t(new a.AppErrorHandling(e,400))}r.send(e.user.tasks)})),r.getTaskById=(0,a.catchError)((async(e,r,t)=>{const o=await s.TaskModel.findOne({_id:e.params.id,owner:e.user._id});if(!o){const{errorFetchTasks:e}=a.MessageLog;return t(new a.AppErrorHandling(e,400))}r.send(o)}))},806:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.getUserById=r.getUser=r.userLogoutAll=r.userLogout=r.userLogin=r.createUser=void 0;const s=t(894),a=t(791),o=t(95),{errorCreateUser:n}=s.MessageLog;r.createUser=(0,s.catchError)((async(e,r,t)=>{const i=new a.UserModel(e.body);if(!i)return t(new s.AppErrorHandling(n,500));await i.save(),(0,o.sendWelcomeEmail)(i.email,i.name);const u=await i.generateAuthToken();r.status(201).send({user:i,token:u})})),r.userLogin=(0,s.catchError)((async(e,r,t)=>{const o=await a.UserModel.findByCredentials(e.body.email,e.body.password);if(!o)return t(new s.AppErrorHandling(n,400));const i=await o.generateAuthToken();r.send({user:o,token:i})})),r.userLogout=(0,s.catchError)((async(e,r,t)=>{e.user.tokens=e.user.tokens.filter((r=>r.token!==e.token));if(!await e.user.save())return t(new s.AppErrorHandling(n,500));r.send()})),r.userLogoutAll=(0,s.catchError)((async(e,r,t)=>{e.user.tokens=[];if(!await e.user.save())return t(new s.AppErrorHandling(n,500));r.send()})),r.getUser=(0,s.catchError)((async(e,r,t)=>{if(e.user)return t(new s.AppErrorHandling(n,500));r.send(e.user)})),r.getUserById=(0,s.catchError)((async(e,r,t)=>{const o=await a.UserModel.findById(e.params.id);if(!o)return t(new s.AppErrorHandling(n,404));r.send(o)}))},95:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.sendWelcomeEmail=void 0;const a=s(t(139));a.default.setApiKey("somekey");r.sendWelcomeEmail=(e,r)=>{a.default.send({to:e,from:"taskManager@gmail.com",subject:"Welcome to task manager",text:`Welcome to task manager ${r}!`,html:"<div>Hi!</div>"})}},145:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.auth=void 0;const a=s(t(344)),o=t(791);r.auth=async(e,r,t)=>{try{const r=e.header("Authorization").replace("Bearer ",""),s=a.default.verify(r,"thisismynewcourse"),n=await o.UserModel.findOne({_id:s._id,"tokens.token":r});if(!n)throw new Error;e.token=r,e.user=n,t()}catch(e){r.status(401).send({error:"Invalid authentication"})}}},614:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.TaskModel=void 0;const s=t(185),a=new s.Schema({description:{type:String,required:!0},completed:{type:Boolean,default:!1},owner:{type:s.Schema.Types.ObjectId,required:!0,ref:"User"}},{timestamps:!0});r.TaskModel=(0,s.model)("Task",a)},791:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.UserModel=void 0;const a=t(185),o=s(t(344)),n=s(t(96)),i=t(614),u=s(t(564)),d=new a.Schema({name:{type:String,required:!0,trim:!0},email:{type:String,required:!0,trim:!0,lowercase:!0,validate(e){if(!u.default.isEmail(e))throw new Error("Email is invalid")}},password:{type:String,required:!0,minlength:7,trim:!0,validate(e){if(e.toLowerCase().includes("passwords"))throw new Error('Password cannot contain "password"')}},age:{type:Number,default:0,validate(e){if(e<0)throw new Error("Age must be a positive number")}},tokens:[{token:{type:String}}],avatar:{type:Buffer}},{timestamps:!0});d.virtual("tasks",{ref:"Task",localField:"_id",foreignField:"owner"}),d.methods.generateAuthToken=async function(){const e=this,r=o.default.sign({_id:e._id.toSring()},"thisismynewcourse",{expiresIn:"7 days"});return e.token=e.tokens.concat({token:r}),await e.save(),r},d.methods.convertJSON=async function(){const e=this.toObject();return delete e.password,delete e.tokens,delete e.avatar,e},d.statics.findByCredentials=async(e,t)=>{const s=await r.UserModel.findOne({email:e});if(!s)throw new Error("Unable to login");if(!await n.default.compare(t,s.password))throw new Error("Unable to login");return s},d.pre("save",(async function(e){const r=this;r.isModified("password")&&(r.password=await n.default.hash(r.password,8)),e()})),d.pre("remove",{document:!0,query:!1},(async function(e){await i.TaskModel.deleteMany({owner:this._id}),e()})),r.UserModel=(0,a.model)("User",d)},622:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const a=s(t(860)),o=t(145),n=t(461),i=a.default.Router();i.post("/tasks",o.auth,n.createTask),i.get("/tasks",o.auth,n.getTask),i.get("/tasks/:id",o.auth,n.getTaskById),r.default=i},430:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const a=s(t(860)),o=s(t(738)),n=s(t(441)),i=t(791),u=t(145),d=t(806),l=a.default.Router();l.post("/users",d.createUser),l.post("/users/login",d.userLogin),l.post("/users/logout",d.userLogout),l.post("/users/logoutAll",d.userLogoutAll),l.get("/users/me",u.auth,d.getUser),l.get("/users/:id",u.auth,d.getUserById),l.patch("/users/me",u.auth,(async(e,r)=>{try{const t=e.user,s=Object.keys(e.body),a=["name","email","password","age"];s.every((e=>a.includes(e)))||r.status(400).send({error:"Invalid updates"}),s.forEach((r=>t[r]=e.body[r])),await t.save(),r.send(e.user)}catch(e){r.status(400).send(e)}})),l.delete("/users/me",u.auth,(async(e,r)=>{try{const t=e.user;await t.remove(),r.send(e.user)}catch(e){r.status(500).send(e)}}));const c=(0,o.default)({limits:{fileSize:1e6},fileFilter(e,r,t){if(r.originalname.match(/\.(doc|docx)$/))return t(new Error("Error in upload format"));t(void 0,!0)}});l.post("/users/me/avatar",u.auth,c.single("avatar"),(async(e,r)=>{try{const t=e.user;t.avatar=await(0,n.default)(e.file.buffer).resize({width:250,height:250}).png().toBuffer(),await t.save(),r.send()}catch(e){r.status(400).send({error:e.message})}})),l.delete("/users/me/avatar",u.auth,(async(e,r)=>{try{const t=e.user;t.avatar=void 0,await t.save(),r.send()}catch(e){r.status(400).send({error:e.message})}})),l.get("/users/:id/avatar",(async(e,r)=>{try{const t=await i.UserModel.findById(e.params.id);if(!t||!t.avatar)throw new Error;r.set("Content-Type","image/jpg"),r.send(t.avatar)}catch(e){r.status(404).send()}})),r.default=l},629:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.AppErrorHandling=void 0;class t extends Error{statusCode;status;isOperational;constructor(e,r){super(e),this.statusCode=r,this.status=`${r}`.startsWith("4")?"fail":"error",this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}}r.AppErrorHandling=t},125:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.catchError=void 0;r.catchError=e=>(r,t,s)=>{e(r,t,s).catch((e=>s(e)))}},109:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.MessageLog=void 0;r.MessageLog={errorSignUp:"Can't SignUp User",errorCreateUser:"Can't Create User",messageSubjectEmailResetPassword:"Your password reset token valid for 10 min",messageTokenSentToEmail:"Token sent to email!",errorFetchUsers:"Can't fetch data user or delete the previous. Please try again later!",errorDeleteUser:"Can't delete user. Please try again later!",errorUpdateProfile:"Can't update profile",errorUpdateUser:"Can't update user",errorCreateTask:"Can't Create Task",errorFetchTasks:"Can't fetch data Task or delete the previous. Please try again later!",errorDeleteTask:"Can't delete Task. Please try again later!",errorUpdateTask:"Can't update Task",errorSomeThingWrong:"Something went very wrong!",errorInvalidToken:"Invalid token. Please log in again!",errorTokenExpired:"Your token has expired! PLease login agian!",errorDuplicate:e=>`Duplicate field value: ${e}. The User has been signup. PLease try use another phone or email`,errorCastMongoose:e=>`Invalid ${e.path}: ${e.value}`,errorValidation:e=>`Invalid input data. ${e.join(". ")} `,messageForgotPassword:e=>`Forgot your password? Submit a PATCH request with your new password and passwordConfirm to: ${e}.\n If you didn't forget your password, please ignore this email!`}},894:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.MessageLog=r.catchError=r.AppErrorHandling=void 0;const s=t(629);Object.defineProperty(r,"AppErrorHandling",{enumerable:!0,get:function(){return s.AppErrorHandling}});const a=t(125);Object.defineProperty(r,"catchError",{enumerable:!0,get:function(){return a.catchError}});const o=t(109);Object.defineProperty(r,"MessageLog",{enumerable:!0,get:function(){return o.MessageLog}})},752:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const a=s(t(860)),o=(s(t(470)),s(t(430))),n=s(t(622)),i=t(201);t(427);const u=(0,a.default)();u.use(a.default.json()),u.use(o.default),u.use(n.default),u.all("*",((e,r,t)=>{r.status(404).json("Error 404")})),u.use(i.ErrorController),r.default=u},728:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const a=s(t(685)),o=s(t(752)),n=a.default.createServer(o.default),i="3000";n.listen(i,(()=>{console.log("Server running on:"+i)}))},139:e=>{e.exports=require("@sendgrid/mail")},96:e=>{e.exports=require("bcrypt")},860:e=>{e.exports=require("express")},344:e=>{e.exports=require("jsonwebtoken")},185:e=>{e.exports=require("mongoose")},470:e=>{e.exports=require("morgan")},738:e=>{e.exports=require("multer")},441:e=>{e.exports=require("sharp")},564:e=>{e.exports=require("validator")},685:e=>{e.exports=require("http")}},r={};(function t(s){var a=r[s];if(void 0!==a)return a.exports;var o=r[s]={exports:{}};return e[s].call(o.exports,o,o.exports,t),o.exports})(728)})();