(()=>{"use strict";var e={427:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const s=a(t(185));s.default.set("strictQuery",!1),s.default.connect("mongodb://localhost:27017/node-task").then((()=>{console.log("Connect to MongoDB")})).catch((e=>console.log(e)))},201:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.ErrorController=void 0;const a=t(629),s=t(894),{errorSomeThingWrong:o,errorDuplicate:n,errorCastMongoose:i,errorValidation:u,errorInvalidToken:d,errorTokenExpired:l}=s.MessageLog;r.ErrorController=(e,r,t,s)=>{e.status=e.status||"error",e.statusCode=e.statusCode||500;{let r={...e};return"CastError"===e.name&&(r=(e=>{const r=i(e);return new a.AppErrorHandling(r,400)})(r)),11e3===r.code&&(r=(e=>{const r=e.errmsg.match(/(["'])(?:(?=(\\?))\2.)*?\1/),t=n(r);return new a.AppErrorHandling(t,400)})(r)),"ValidationError"===r.name&&(r=(e=>{const r=Object.values(e.errors).map((e=>e.message)),t=u(r);return new a.AppErrorHandling(t,400)})(r)),"JsonWebTokenError"===r.name&&(r=new a.AppErrorHandling(d,401)),"TokenExpiredError"===r.name&&(r=new a.AppErrorHandling(l,401)),((e,r)=>{e.isOperational?r.status(e.statusCode).json({status:e.status,message:e.message}):(console.error("ERROR ðŸŽ†",e),r.status(500).json({status:"error",message:o}))})(r,t)}}},461:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.getTaskById=r.getTask=r.createTask=void 0;const a=t(614),s=t(894);r.createTask=(0,s.catchError)((async(e,r,t)=>{const o=e.user,n=new a.TaskModel({...e.body,owner:o._id});if(!n){const{errorCreateTask:e}=s.MessageLog;return t(new s.AppErrorHandling(e,400))}await n.save(),r.status(201).send(n)})),r.getTask=(0,s.catchError)((async(e,r,t)=>{const a=e.user,o={},n={};if(e.query.completed&&(o.completed="true"===e.query.completed),e.query.sortBy){const r=e.query.sortBy.split(":");n[r[0]]="desc"===r[1]?-1:1}if(!await a.populate({path:"tasks",match:o,options:{limit:parseInt(e.query.limit),skip:parseInt(e.query.skip),sort:n}})){const{errorFetchTasks:e}=s.MessageLog;return t(new s.AppErrorHandling(e,400))}r.send(e.user.tasks)})),r.getTaskById=(0,s.catchError)((async(e,r,t)=>{const o=await a.TaskModel.findOne({_id:e.params.id,owner:e.user._id});if(!o){const{errorFetchTasks:e}=s.MessageLog;return t(new s.AppErrorHandling(e,400))}r.send(o)}))},806:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.getAvatarUser=r.deleteAvatarUser=r.uploadAvatarUser=r.deleteUser=r.getUserMe=r.getUserById=r.getUser=r.userLogoutAll=r.userLogout=r.userLogin=r.createUser=void 0;const s=a(t(441)),o=t(894),n=t(791),i=t(95),{errorCreateUser:u}=o.MessageLog;r.createUser=(0,o.catchError)((async(e,r,t)=>{const a=new n.UserModel(e.body);if(!a)return t(new o.AppErrorHandling(u,500));await a.save(),(0,i.sendWelcomeEmail)(a.email,a.name);const s=await a.generateAuthToken();r.status(201).send({user:a,token:s})})),r.userLogin=(0,o.catchError)((async(e,r,t)=>{const a=await n.UserModel.findByCredentials(e.body.email,e.body.password);if(!a)return t(new o.AppErrorHandling(u,400));const s=await a.generateAuthToken();r.send({user:a,token:s})})),r.userLogout=(0,o.catchError)((async(e,r,t)=>{e.user.tokens=e.user.tokens.filter((r=>r.token!==e.token));if(!(await e.user.save()).isNew)return t(new o.AppErrorHandling(u,500));r.send()})),r.userLogoutAll=(0,o.catchError)((async(e,r,t)=>{e.user.tokens=[];if(!(await e.user.save()).isNew)return t(new o.AppErrorHandling(u,500));r.send()})),r.getUser=(0,o.catchError)((async(e,r,t)=>{if(e.user)return t(new o.AppErrorHandling(u,500));r.send(e.user)})),r.getUserById=(0,o.catchError)((async(e,r,t)=>{const a=await n.UserModel.findById(e.params.id);if(!a)return t(new o.AppErrorHandling(u,404));r.send(a)})),r.getUserMe=(0,o.catchError)((async(e,r,t)=>{const a=e.user,s=Object.keys(e.body),n=["name","email","password","age"];if(!s.every((e=>n.includes(e))))return t(new o.AppErrorHandling("Invalid updates",400));s.forEach((r=>a[r]=e.body[r]));if(!(await a.save()).isNew)return t(new o.AppErrorHandling("Updates Err",400));r.send(e.user)})),r.deleteUser=(0,o.catchError)((async(e,r,t)=>{if(!(await e.user.remove()).$isDeleted)return t(new o.AppErrorHandling("Delete Err",500));r.send(e.user)})),r.uploadAvatarUser=(0,o.catchError)((async(e,r,t)=>{const a=e.user;a.avatar=await(0,s.default)(e.file.buffer).resize({width:250,height:250}).png().toBuffer();if(!(await a.save()).isNew)return t(new o.AppErrorHandling("Upload Avatar Err",400));r.send()})),r.deleteAvatarUser=(0,o.catchError)((async(e,r,t)=>{e.user.avatar=void 0;if(!(await e.user.save()).$isDeleted)return t(new o.AppErrorHandling("Delete Avatar",400));r.send()})),r.getAvatarUser=(0,o.catchError)((async(e,r,t)=>{const a=await n.UserModel.findById(e.params.id);if(!a||!a.avatar)throw new Error;r.set("Content-Type","image/jpg"),r.send(a.avatar),r.status(404).send()}))},95:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.sendWelcomeEmail=void 0;const s=a(t(139));s.default.setApiKey("somekey");r.sendWelcomeEmail=(e,r)=>{s.default.send({to:e,from:"taskManager@gmail.com",subject:"Welcome to task manager",text:`Welcome to task manager ${r}!`,html:"<div>Hi!</div>"})}},145:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.auth=void 0;const s=a(t(344)),o=t(791);r.auth=async(e,r,t)=>{try{const r=e.header("Authorization").replace("Bearer ",""),a=s.default.verify(r,"thisismynewcourse"),n=await o.UserModel.findOne({_id:a._id,"tokens.token":r});if(!n)throw new Error;e.token=r,e.user=n,t()}catch(e){r.status(401).send({error:"Invalid authentication"})}}},614:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.TaskModel=void 0;const a=t(185),s=new a.Schema({description:{type:String,required:!0},completed:{type:Boolean,default:!1},owner:{type:a.Schema.Types.ObjectId,required:!0,ref:"User"}},{timestamps:!0});r.TaskModel=(0,a.model)("Task",s)},791:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.UserModel=void 0;const s=t(185),o=a(t(344)),n=a(t(96)),i=t(614),u=a(t(564)),d=new s.Schema({name:{type:String,required:!0,trim:!0},email:{type:String,required:!0,trim:!0,lowercase:!0,validate(e){if(!u.default.isEmail(e))throw new Error("Email is invalid")}},password:{type:String,required:!0,minlength:7,trim:!0,validate(e){if(e.toLowerCase().includes("passwords"))throw new Error('Password cannot contain "password"')}},age:{type:Number,default:0,validate(e){if(e<0)throw new Error("Age must be a positive number")}},tokens:[{token:{type:String}}],avatar:{type:Buffer}},{timestamps:!0});d.virtual("tasks",{ref:"Task",localField:"_id",foreignField:"owner"}),d.methods.generateAuthToken=async function(){const e=this,r=o.default.sign({_id:e._id.toSring()},"thisismynewcourse",{expiresIn:"7 days"});return e.token=e.tokens.concat({token:r}),await e.save(),r},d.methods.convertJSON=async function(){const e=this.toObject();return delete e.password,delete e.tokens,delete e.avatar,e},d.statics.findByCredentials=async(e,t)=>{const a=await r.UserModel.findOne({email:e});if(!a)throw new Error("Unable to login");if(!await n.default.compare(t,a.password))throw new Error("Unable to login");return a},d.pre("save",(async function(e){const r=this;r.isModified("password")&&(r.password=await n.default.hash(r.password,8)),e()})),d.pre("remove",{document:!0,query:!1},(async function(e){await i.TaskModel.deleteMany({owner:this._id}),e()})),r.UserModel=(0,s.model)("User",d)},622:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const s=a(t(860)),o=t(145),n=t(461),i=s.default.Router();i.post("/tasks",o.auth,n.createTask),i.get("/tasks",o.auth,n.getTask),i.get("/tasks/:id",o.auth,n.getTaskById),r.default=i},430:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const s=a(t(860)),o=t(145),n=t(806),i=t(894),u=s.default.Router();u.post("/users",n.createUser),u.post("/users/login",n.userLogin),u.post("/users/logout",n.userLogout),u.post("/users/logoutAll",n.userLogoutAll),u.get("/users/me",o.auth,n.getUser),u.get("/users/:id",o.auth,n.getUserById),u.patch("/users/me",o.auth,n.getUserMe),u.delete("/users/me",o.auth,n.deleteUser),u.post("/users/me/avatar",o.auth,i.upload.single("avatar"),n.uploadAvatarUser),u.delete("/users/me/avatar",o.auth,n.deleteAvatarUser),u.get("/users/:id/avatar",n.getAvatarUser),r.default=u},629:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.AppErrorHandling=void 0;class t extends Error{statusCode;status;isOperational;constructor(e,r){super(e),this.statusCode=r,this.status=`${r}`.startsWith("4")?"fail":"error",this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}}r.AppErrorHandling=t},125:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.catchError=void 0;r.catchError=e=>(r,t,a)=>{e(r,t,a).catch((e=>a(e)))}},425:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.upload=void 0;const s=a(t(738));r.upload=(0,s.default)({limits:{fileSize:1e6},fileFilter(e,r,t){if(r.originalname.match(/\.(doc|docx)$/))return t(new Error("Error in upload format"));t(void 0,!0)}})},109:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.MessageLog=void 0;r.MessageLog={errorSignUp:"Can't SignUp User",errorCreateUser:"Can't Create User",messageSubjectEmailResetPassword:"Your password reset token valid for 10 min",messageTokenSentToEmail:"Token sent to email!",errorFetchUsers:"Can't fetch data user or delete the previous. Please try again later!",errorDeleteUser:"Can't delete user. Please try again later!",errorUpdateProfile:"Can't update profile",errorUpdateUser:"Can't update user",errorCreateTask:"Can't Create Task",errorFetchTasks:"Can't fetch data Task or delete the previous. Please try again later!",errorDeleteTask:"Can't delete Task. Please try again later!",errorUpdateTask:"Can't update Task",errorSomeThingWrong:"Something went very wrong!",errorInvalidToken:"Invalid token. Please log in again!",errorTokenExpired:"Your token has expired! PLease login agian!",errorDuplicate:e=>`Duplicate field value: ${e}. The User has been signup. PLease try use another phone or email`,errorCastMongoose:e=>`Invalid ${e.path}: ${e.value}`,errorValidation:e=>`Invalid input data. ${e.join(". ")} `,messageForgotPassword:e=>`Forgot your password? Submit a PATCH request with your new password and passwordConfirm to: ${e}.\n If you didn't forget your password, please ignore this email!`}},894:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.upload=r.MessageLog=r.catchError=r.AppErrorHandling=void 0;const a=t(629);Object.defineProperty(r,"AppErrorHandling",{enumerable:!0,get:function(){return a.AppErrorHandling}});const s=t(125);Object.defineProperty(r,"catchError",{enumerable:!0,get:function(){return s.catchError}});const o=t(109);Object.defineProperty(r,"MessageLog",{enumerable:!0,get:function(){return o.MessageLog}});const n=t(425);Object.defineProperty(r,"upload",{enumerable:!0,get:function(){return n.upload}})},752:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const s=a(t(860)),o=(a(t(470)),a(t(430))),n=a(t(622)),i=t(201);t(427);const u=(0,s.default)();u.use(s.default.json()),u.use(o.default),u.use(n.default),u.all("*",((e,r,t)=>{r.status(404).json("Error 404")})),u.use(i.ErrorController),r.default=u},728:function(e,r,t){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const s=a(t(685)),o=a(t(752)),n=s.default.createServer(o.default),i="3000";n.listen(i,(()=>{console.log("Server running on:"+i)}))},139:e=>{e.exports=require("@sendgrid/mail")},96:e=>{e.exports=require("bcrypt")},860:e=>{e.exports=require("express")},344:e=>{e.exports=require("jsonwebtoken")},185:e=>{e.exports=require("mongoose")},470:e=>{e.exports=require("morgan")},738:e=>{e.exports=require("multer")},441:e=>{e.exports=require("sharp")},564:e=>{e.exports=require("validator")},685:e=>{e.exports=require("http")}},r={};(function t(a){var s=r[a];if(void 0!==s)return s.exports;var o=r[a]={exports:{}};return e[a].call(o.exports,o,o.exports,t),o.exports})(728)})();